![](https://img.shields.io/badge/build-passing-brightgreen) ![](https://img.shields.io/badge/ubuntu-18.04-blue) ![](https://img.shields.io/badge/protobuf-3.20-blue) ![](https://img.shields.io/badge/zookeeper-3.4.10-blue) ![](https://img.shields.io/badge/cmake-3.21-blue)

# é¡¹ç›®æŠ€æœ¯

- é›†ç¾¤å’Œåˆ†å¸ƒå¼æ¦‚å¿µä»¥åŠåŸç†
- RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨åŸç†ä»¥åŠå®ç°
- Protobufæ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®
- ZooKeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åè°ƒæœåŠ¡åº”ç”¨ä»¥åŠç¼–ç¨‹
- muduoç½‘ç»œç¼–ç¨‹
- confé…ç½®æ–‡ä»¶çš„ç£å­¦
- å¼‚æ­¥æ—¥å¿—
- CMakeæ­å»ºé¡¹ç›®é›†æˆç¼–è¯‘ç¯å¢ƒ
- githubç®¡ç†é¡¹ç›®



## é¡¹ç›®çš„ç›®å½•

bin å¯æ‰§è¡Œæ–‡ä»¶

build: é¡¹ç›®ç¼–è¯‘æ–‡ä»¶

lib: é¡¹ç›®åº“æ–‡ä»¶

src: æºæ–‡ä»¶

test: æµ‹è¯•ä»£ç 

example: æ¡†æ¶ä»£ç ä½¿ç”¨èŒƒä¾‹

CMakeList.txt é¡¶å±‚çš„cmakeæ–‡ä»¶

README.md

autobuild.sh ä¸€é”®ç¼–è¯‘è„šæœ¬

# é›†ç¾¤å’Œåˆ†å¸ƒå¼ç†è®º

**é›†ç¾¤**ï¼šæ¯ä¸€å°æœåŠ¡å™¨ç‹¬ç«‹è¿è¡Œä¸€ä¸ªå·¥ç¨‹çš„æ‰€æœ‰æ¨¡å—ã€‚

**åˆ†å¸ƒå¼**ï¼š ä¸€ä¸ªå·¥ç¨‹æ‹†åˆ†äº†å¾ˆå¤šæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç‹¬ç«‹éƒ¨ç½²è¿è¡Œåœ¨ä¸€ä¸ªæœåŠ¡å™¨å™¨ä¸»æœºä¸Šï¼Œæ‰€æœ‰æœåŠ¡å™¨ååŒå·¥ä½œå…±åŒæä¾›æœåŠ¡ï¼Œæ¯ä¸€å°æœåŠ¡å™¨ç§°ä½œåˆ†å¸ƒå¼çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ¹æ®èŠ‚ç‚¹çš„å¹¶å‘è¦æ±‚ï¼Œå¯¹ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å†åšèŠ‚ç‚¹æ¨¡å—é›†ç¾¤éƒ¨ç½²ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š

ä¸€é“é˜¿é‡Œçš„é¢è¯•é¢˜ï¼š

è®©ä½ è®¾è®¡ä¸€ä¸ªèŠå¤©ç¨‹åº ä½ ä¼šå¦‚ä½•åšï¼š







# RPCé€šä¿¡åŸç†ä»¥åŠé¡¹ç›®çš„æŠ€æœ¯é€‰å‹

![image-20220507193732134](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220507193732134.png)

è“è‰²éƒ¨åˆ†æ˜¯æˆ‘ä»¬è¦å®ç°çš„åˆ†å¸ƒå¼ç½‘ç»œé€šä¿¡æ¡†æ¶è´Ÿè´£å¤„ç†çš„èŒƒå›´

**(è¿™é‡Œçš„æ¶æ„å›¾éœ€è¦é‡æ–°ç»˜åˆ¶ä¸€ä¸‹)**

**é»„è‰²éƒ¨åˆ†**ï¼šè®¾è®¡rpcæ–¹æ³•å‚æ•°çš„æ‰“åŒ…å’Œè§£æï¼Œä¹Ÿå°±æ˜¯æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä½¿ç”¨Protobufã€‚
**ç»¿è‰²éƒ¨åˆ†**ï¼šç½‘ç»œéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¯»æ‰¾rpcæœåŠ¡ä¸»æœºï¼Œå‘èµ·rpcè°ƒç”¨è¯·æ±‚å’Œå“åº”rpcè°ƒç”¨ç»“æœï¼Œä½¿ç”¨muduoç½‘ç»œåº“å’ŒzookeeperæœåŠ¡é…ç½®ä¸­å¿ƒï¼ˆä¸“é—¨åšæœåŠ¡å‘ç°ï¼‰ã€‚
mprpcæ¡†æ¶ä¸»è¦åŒ…å«ä»¥ä¸Šä¸¤ä¸ªéƒ¨åˆ†çš„å†…å®¹

æ³¨æ„ï¼š

Caller  æœåŠ¡æ¶ˆè´¹

Callee æä¾›æœåŠ¡





# Protobuf

## Protobuf å®‰è£…

æ˜¯`google`çš„ä¸€ç§æ•°æ®äº¤æ¢çš„æ ¼å¼ï¼Œæ¯”ä½¿ç”¨xmlå¿«20å€ã€‚



### å…³äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–

https://mp.weixin.qq.com/s/12sjb3WTKdQaDc0bvEX_ow



### ä¸ºä»€ä¹ˆåºåˆ—å’Œååºåˆ—é‡‡ç”¨protobuf è€Œä¸æ˜¯ç”¨json

protobufæ˜¯äºŒè¿›åˆ¶å­˜å‚¨çš„ï¼›xmlå’Œjson æ˜¯æ–‡æœ¬å­˜å‚¨

protobuf ä¸éœ€è¦å­˜å‚¨é¢å¤–çš„ä¿¡æ¯ï¼›json æ€ä¹ˆå­˜å‚¨æ•°æ®çš„å‘¢ï¼Ÿ

ä¸¾ä¸ªğŸŒ°

```
name:"zhang san", pwd:"123"

protobuf åˆ™æ˜¯ç›´æ¥å­˜å‚¨äºŒè¿›åˆ¶æ•°
```



## protobuf ååºåˆ—åŒ–çš„æ­å»º

æ•°æ®ç±»å‹

å„ä¸ªç±»å‹çš„ä½¿ç”¨æ–¹å¼ã€‚

![image-20220519192332057](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220519192332057.png)

server1 



protobuf åšRPC æ–¹æ³•çš„åºåˆ—å’Œååºåˆ—åŒ–



## protobuf åœ¨é¡¹ç›®ä¸­çš„ä½œç”¨

éœ€è¦å…ˆæ·»åŠ `option ` è¡¨ç¤ºç”ŸæˆserviceæœåŠ¡ç±»å’Œé»˜è®¤çš„é€‰é¡¹

### æ¶ˆæ¯æ–¹æ³•

message LoginRequest  çš„å…·ä½“çš„å®ç°æ–¹æ³•ï¼š

> æ„Ÿè§‰è·ŸJAVAçš„å®ç°å¾ˆç±»ä¼¼

![image-20220520103028969](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103028969.png)



### æœåŠ¡æ–¹æ³•

åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

`rpc`æœåŠ¡æä¾›è€…

`rpc`æœåŠ¡æ¶ˆè´¹è€…

![image-20220520103209393](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103209393.png)

![image-20220520103252795](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103252795.png)

![image-20220520101859761](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520101859761.png)

**å‚æ•°çš„ç®€å•æè¿°**

å®šä¹‰äº†å‡ ä¸ªæ–¹æ³•å°±ä¼šæœ‰å‡ ä¸ªæ–¹æ³•äº§ç”Ÿ

æ¯ä¸ªæ–¹æ³•éƒ½æœ‰å››ä¸ªå‚æ•°

å…·ä½“çš„è°ƒç”¨çš„æ–¹æ³•requeset

å“åº”çš„æ–¹æ³• respone

GetDescriptorï¼ˆï¼‰ æè¿°

æœåŠ¡çš„æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…

![image-20220520103125936](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103125936.png)

æ¶ˆè´¹è€…æ˜¯å¸¦å‚æ•°çš„æ„é€ å‡½æ•° æœ‰ä¸€ä¸ª`RpcChannel*`

### å…·ä½“çš„å®ç°æ–¹æ³•

![image-20220520103148307](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103148307.png)

è¿™é‡Œå…¶å®å°±æ˜¯ç»§æ‰¿äº†è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»å®ç°å¤šæ€ã€‚





# æœ¬åœ°æœåŠ¡æ€ä¹ˆå‘å¸ƒæˆrpcæœåŠ¡

## cmakeçš„ä½¿ç”¨æ–¹æ³•

ä½¿ç”¨åå¤´æ–‡ä»¶è·¯å¾„å¯»æ‰¾å¾ˆæ–¹ä¾¿ã€‚





RPCä¸»è¦åˆ†ä¸º `caller`ä¸`callee`

ä»¥`ä¸šåŠ¡`ä¸ºé©±åŠ¨ æŒæ¡æ¡†æ¶çš„ä½¿ç”¨

ä»¥ä¸‹å†™çš„æ˜¯ä¸šåŠ¡ã€‚

`xxserviceRpc` æ˜¯ç»™æœåŠ¡æä¾›è€…ç”¨ï¼Œ `xxServiceRpc_Stub` æœåŠ¡è°ƒç”¨è€…

æµç¨‹ï¼š

å…ˆåœ¨`user.proto`ä¸­è¿›è¡Œç›¸åº”çš„çº¦å®šï¼Œå£°æ˜è°ƒç”¨çš„å‡½æ•°ä»¥åŠè°ƒç”¨å½¢å¼å’Œè¿”å›å€¼

ç„¶åç»§æ‰¿è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»ï¼Œç±»ä¸­æ–¹æ³•å°±æ˜¯protoä¸­å†™çš„rpcæ–¹æ³•

è®©æ¡†æ¶æ¥è°ƒç”¨æˆ‘æˆ‘ä»¬çš„ä»£ç 

user.protoæ–¹æ³•

```protobuf
message LoginRequest
{
    bytes name = 1;
    bytes pwd = 2;
}

message LoginResponse
{
    ResultCode result = 1;
    bool sucess = 2;
}
```



```cpp
/*
UserServiceåŸæ¥æ˜¯ä¸€ä¸ªæœ¬åœ°æœåŠ¡ï¼Œæä¾›äº†ä¸¤ä¸ªè¿›ç¨‹å†…çš„æœ¬åœ°æ–¹æ³•ï¼ŒLoginå’ŒGetFriendLists
*/
class UserService : public fixbug::UserServiceRpc // ä½¿ç”¨åœ¨rpcæœåŠ¡å‘å¸ƒç«¯ï¼ˆrpcæœåŠ¡æä¾›è€…ï¼‰
{
public:
    bool Login(std::string name, std::string pwd)
    {
        std::cout << "doing local service: Login" << std::endl;
        std::cout << "name:" << name << " pwd:" << pwd << std::endl;  
        return false;
    }
 
       /*
    é‡å†™åŸºç±»UserServiceRpcçš„è™šå‡½æ•° ä¸‹é¢è¿™äº›æ–¹æ³•éƒ½æ˜¯æ¡†æ¶ç›´æ¥è°ƒç”¨çš„
    1. caller   ===>   Login(LoginRequest)  => muduo =>   callee 
    2. callee   ===>    Login(LoginRequest)  => äº¤åˆ°ä¸‹é¢é‡å†™çš„è¿™ä¸ªLoginæ–¹æ³•ä¸Šäº†
    */
    void Login(::google::protobuf::RpcController* controller,
                       const ::fixbug::LoginRequest* request,
                       ::fixbug::LoginResponse* response,
                       ::google::protobuf::Closure* done)
    {
        // æ¡†æ¶ç»™ä¸šåŠ¡ä¸ŠæŠ¥äº†è¯·æ±‚å‚æ•°LoginRequestï¼Œåº”ç”¨è·å–ç›¸åº”æ•°æ®åšæœ¬åœ°ä¸šåŠ¡
        std::string name = request->name();
        std::string pwd = request->pwd();

        // åšæœ¬åœ°ä¸šåŠ¡
        bool login_result = Login(name, pwd); 

        // æŠŠå“åº”å†™å…¥  åŒ…æ‹¬é”™è¯¯ç ã€é”™è¯¯æ¶ˆæ¯ã€è¿”å›å€¼
        fixbug::ResultCode *code = response->mutable_result();
        code->set_errcode(0);
        code->set_errmsg("");
        response->set_sucess(login_result);

        // æ‰§è¡Œå›è°ƒæ“ä½œ   æ‰§è¡Œå“åº”å¯¹è±¡æ•°æ®çš„åºåˆ—åŒ–å’Œç½‘ç»œå‘é€ï¼ˆéƒ½æ˜¯ç”±æ¡†æ¶æ¥å®Œæˆçš„ï¼‰
        done->Run();
    }

}
```

> æ³¨æ„ä½¿ç”¨å‘½åç©ºé—´ 

æ¡†æ¶å¸®æˆ‘ä»¬ä»è¿œç«¯æ¥æ”¶RPCè¯·æ±‚ï¼ŒRPCæè¿°æ–¹æ³•å’Œå‚æ•°ï¼Œé€šè¿‡ä¸€ç³»åˆ—å‚æ•°å®Œæˆå“åº”çš„å‡½æ•°



ä»€ä¹ˆå«åšæœ¬åœ°ä¸šåŠ¡





## `Mprpc`æ¡†æ¶åŸºç¡€ç±»è®¾è®¡

è°ƒç”¨æ¡†æ¶çš„åˆå§‹åŒ–æ“ä½œ

æ¡†æ¶å¯ä»¥æä¾›æœåŠ¡ `provider` å¯¹è±¡

å¯åŠ¨ä¸€ä¸ªRPCæœåŠ¡å‘å¸ƒèŠ‚ç‚¹ï¼Œ`Run`ä»¥åï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è¿œç¨‹çš„`rpc`è°ƒç”¨è¯·æ±‚



```cpp
int main(int argc, char **argv)
{
    // è°ƒç”¨æ¡†æ¶çš„åˆå§‹åŒ–æ“ä½œ
    MprpcApplication::Init(argc, argv);

    // provideræ˜¯ä¸€ä¸ªrpcç½‘ç»œæœåŠ¡å¯¹è±¡ã€‚æŠŠUserServiceå¯¹è±¡å‘å¸ƒåˆ°rpcèŠ‚ç‚¹ä¸Š
    RpcProvider provider;
    provider.NotifyService(new UserService());

    // å¯åŠ¨ä¸€ä¸ªrpcæœåŠ¡å‘å¸ƒèŠ‚ç‚¹   Runä»¥åï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è¿œç¨‹çš„rpcè°ƒç”¨è¯·æ±‚
    provider.Run();

    return 0;
}
```



æ¡†æ¶çš„ä»£ç éƒ½æ˜¯æ”¾åœ¨srcï¼ŒåŠ¨æ€åº“éƒ½åœ¨æ”¾åœ¨`src.include`ä¸­





# å…·ä½“çš„å®ç°

æ³¨æ„ï¼š

æˆ‘ä»¬æ­å»ºrpcçš„æœåŠ¡æ¡†æ¶çš„æ—¶å€™ï¼Œæ˜¯è¦æ­å»ºé€šç”¨çš„æ¡†æ¶ï¼Œæ¯”å¦‚åœ¨`rpcprovider.h`ä¸­çš„ `NotifyServie`æœåŠ¡ä¸­ï¼Œæˆ‘çš„å‚æ•°å¯¹è±¡åº”è¯¥ä¸º`google::protobuf::Service *service`

```
    // è¿™é‡Œæ˜¯æ¡†æ¶æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„ï¼Œå¯ä»¥å‘å¸ƒrpcæ–¹æ³•çš„å‡½æ•°æ¥å£
    void NotifyService(google::protobuf::Service *service);

    // å¯åŠ¨rpcæœåŠ¡èŠ‚ç‚¹ï¼Œå¼€å§‹æä¾›rpcè¿œç¨‹ç½‘ç»œè°ƒç”¨æœåŠ¡
    void Run();
```







## 20225.25

æ‰¾åˆ°ç›¸å…³çš„ä»£ç 

> https://github.com/wangzyon/mpzRPC

é…ç½®ç¯å¢ƒ

> è½»é‡çº§çš„ [MessagePack RPC](https://github.com/msgpack-rpc/msgpack-rpc) è¿œç¨‹æ–¹æ³•è°ƒç”¨åº“

muduoåº“

google protobuf å®‰è£…

linux ISO

ä¸€äº›å¸¸è§çš„apt æŒ‡ä»¤ 

dockerå®¹å™¨é…ç½®











**for apt-get:**
export PATH=/usr/bin:$PATH
protoc --version

**and for source:**
export PATH=/usr/local/bin:$PATH
protoc --version

> then removed the one installed through source,next I checked again and both were the same version.
> after that I used **make clean**, and then **make test**, and voila! the problem solved for my case.
