![](https://img.shields.io/badge/build-passing-brightgreen) ![](https://img.shields.io/badge/ubuntu-18.04-blue) ![](https://img.shields.io/badge/protobuf-3.20-blue) ![](https://img.shields.io/badge/zookeeper-3.4.10-blue) ![](https://img.shields.io/badge/cmake-3.21-blue)





# é¡¹ç›®æŠ€æœ¯

- é›†ç¾¤å’Œåˆ†å¸ƒå¼æ¦‚å¿µä»¥åŠåŸç†
- RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨åŸç†ä»¥åŠå®ç°
- Protobufæ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®
- ZooKeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åè°ƒæœåŠ¡åº”ç”¨ä»¥åŠç¼–ç¨‹
- muduoç½‘ç»œç¼–ç¨‹
- confé…ç½®æ–‡ä»¶çš„ç£å­¦
- å¼‚æ­¥æ—¥å¿—
- **CMake**æ­å»ºé¡¹ç›®é›†æˆç¼–è¯‘ç¯å¢ƒ
- githubç®¡ç†é¡¹ç›®



## é¡¹ç›®çš„ç›®å½•

bin å¯æ‰§è¡Œæ–‡ä»¶

build: é¡¹ç›®ç¼–è¯‘æ–‡ä»¶

lib: é¡¹ç›®åº“æ–‡ä»¶

src: æºæ–‡ä»¶

test: æµ‹è¯•ä»£ç 

example: æ¡†æ¶ä»£ç ä½¿ç”¨èŒƒä¾‹

CMakeList.txt é¡¶å±‚çš„cmakeæ–‡ä»¶

README.md

autobuild.sh ä¸€é”®ç¼–è¯‘è„šæœ¬

# é›†ç¾¤å’Œåˆ†å¸ƒå¼ç†è®º

**é›†ç¾¤**ï¼šæ¯ä¸€å°æœåŠ¡å™¨ç‹¬ç«‹è¿è¡Œä¸€ä¸ªå·¥ç¨‹çš„æ‰€æœ‰æ¨¡å—ã€‚

**åˆ†å¸ƒå¼**ï¼š ä¸€ä¸ªå·¥ç¨‹æ‹†åˆ†äº†å¾ˆå¤šæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç‹¬ç«‹éƒ¨ç½²è¿è¡Œåœ¨ä¸€ä¸ªæœåŠ¡å™¨å™¨ä¸»æœºä¸Šï¼Œæ‰€æœ‰æœåŠ¡å™¨ååŒå·¥ä½œå…±åŒæä¾›æœåŠ¡ï¼Œæ¯ä¸€å°æœåŠ¡å™¨ç§°ä½œåˆ†å¸ƒå¼çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ ¹æ®èŠ‚ç‚¹çš„å¹¶å‘è¦æ±‚ï¼Œå¯¹ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å†åšèŠ‚ç‚¹æ¨¡å—é›†ç¾¤éƒ¨ç½²ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š

ä¸€é“é˜¿é‡Œçš„é¢è¯•é¢˜ï¼š

è®©ä½ è®¾è®¡ä¸€ä¸ªèŠå¤©ç¨‹åº ä½ ä¼šå¦‚ä½•åšï¼š







# RPCé€šä¿¡åŸç†ä»¥åŠé¡¹ç›®çš„æŠ€æœ¯é€‰å‹

![image-20220507193732134](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220507193732134.png)

è“è‰²éƒ¨åˆ†æ˜¯æˆ‘ä»¬è¦å®ç°çš„åˆ†å¸ƒå¼ç½‘ç»œé€šä¿¡æ¡†æ¶è´Ÿè´£å¤„ç†çš„èŒƒå›´

**(è¿™é‡Œçš„æ¶æ„å›¾éœ€è¦é‡æ–°ç»˜åˆ¶ä¸€ä¸‹)**

**é»„è‰²éƒ¨åˆ†**ï¼šè®¾è®¡rpcæ–¹æ³•å‚æ•°çš„æ‰“åŒ…å’Œè§£æï¼Œä¹Ÿå°±æ˜¯æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä½¿ç”¨Protobufã€‚
**ç»¿è‰²éƒ¨åˆ†**ï¼šç½‘ç»œéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¯»æ‰¾rpcæœåŠ¡ä¸»æœºï¼Œå‘èµ·rpcè°ƒç”¨è¯·æ±‚å’Œå“åº”rpcè°ƒç”¨ç»“æœï¼Œä½¿ç”¨muduoç½‘ç»œåº“å’ŒzookeeperæœåŠ¡é…ç½®ä¸­å¿ƒï¼ˆä¸“é—¨åšæœåŠ¡å‘ç°ï¼‰ã€‚
mprpcæ¡†æ¶ä¸»è¦åŒ…å«ä»¥ä¸Šä¸¤ä¸ªéƒ¨åˆ†çš„å†…å®¹

æ³¨æ„ï¼š

Caller  æœåŠ¡æ¶ˆè´¹

Callee æä¾›æœåŠ¡





# é¢„å¤‡çŸ¥è¯†







# Protobuf

## Protobuf å®‰è£…

æ˜¯`google`çš„ä¸€ç§æ•°æ®äº¤æ¢çš„æ ¼å¼ï¼Œæ¯”ä½¿ç”¨xmlå¿«20å€ã€‚



### å…³äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–

https://mp.weixin.qq.com/s/12sjb3WTKdQaDc0bvEX_ow



### ä¸ºä»€ä¹ˆåºåˆ—å’Œååºåˆ—é‡‡ç”¨protobuf è€Œä¸æ˜¯ç”¨json

protobufæ˜¯äºŒè¿›åˆ¶å­˜å‚¨çš„ï¼›xmlå’Œjson æ˜¯æ–‡æœ¬å­˜å‚¨

protobuf ä¸éœ€è¦å­˜å‚¨é¢å¤–çš„ä¿¡æ¯ï¼›json æ€ä¹ˆå­˜å‚¨æ•°æ®çš„å‘¢ï¼Ÿ

ä¸¾ä¸ªğŸŒ°

```
name:"zhang san", pwd:"123"

protobuf åˆ™æ˜¯ç›´æ¥å­˜å‚¨äºŒè¿›åˆ¶æ•°
```



## protobuf ååºåˆ—åŒ–çš„æ­å»º

æ•°æ®ç±»å‹

å„ä¸ªç±»å‹çš„ä½¿ç”¨æ–¹å¼ã€‚

![image-20220519192332057](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220519192332057.png)

server1 



protobuf åšRPC æ–¹æ³•çš„åºåˆ—å’Œååºåˆ—åŒ–



## protobuf åœ¨é¡¹ç›®ä¸­çš„ä½œç”¨

éœ€è¦å…ˆæ·»åŠ `option ` è¡¨ç¤ºç”ŸæˆserviceæœåŠ¡ç±»å’Œé»˜è®¤çš„é€‰é¡¹

### æ¶ˆæ¯æ–¹æ³•

message LoginRequest  çš„å…·ä½“çš„å®ç°æ–¹æ³•ï¼š

> æ„Ÿè§‰è·ŸJAVAçš„å®ç°å¾ˆç±»ä¼¼

![image-20220520103028969](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103028969.png)



### æœåŠ¡æ–¹æ³•

åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

`rpc`æœåŠ¡æä¾›è€…

`rpc`æœåŠ¡æ¶ˆè´¹è€…

![image-20220520103209393](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103209393.png)

![image-20220520103252795](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103252795.png)

![image-20220520101859761](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520101859761.png)

**å‚æ•°çš„ç®€å•æè¿°**

å®šä¹‰äº†å‡ ä¸ªæ–¹æ³•å°±ä¼šæœ‰å‡ ä¸ªæ–¹æ³•äº§ç”Ÿ

æ¯ä¸ªæ–¹æ³•éƒ½æœ‰å››ä¸ªå‚æ•°

å…·ä½“çš„è°ƒç”¨çš„æ–¹æ³•requeset

å“åº”çš„æ–¹æ³• respone

GetDescriptorï¼ˆï¼‰ æè¿°

æœåŠ¡çš„æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…

![image-20220520103125936](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103125936.png)

æ¶ˆè´¹è€…æ˜¯å¸¦å‚æ•°çš„æ„é€ å‡½æ•° æœ‰ä¸€ä¸ª`RpcChannel*`

### å…·ä½“çš„å®ç°æ–¹æ³•

![image-20220520103148307](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220520103148307.png)

è¿™é‡Œå…¶å®å°±æ˜¯ç»§æ‰¿äº†è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±»å®ç°å¤šæ€ã€‚





# æœ¬åœ°æœåŠ¡æ€ä¹ˆå‘å¸ƒæˆrpcæœåŠ¡

## cmakeçš„ä½¿ç”¨æ–¹æ³•

ä½¿ç”¨åå¤´æ–‡ä»¶è·¯å¾„å¯»æ‰¾å¾ˆæ–¹ä¾¿ã€‚





RPCä¸»è¦åˆ†ä¸º `caller`ä¸`callee`

ä»¥`ä¸šåŠ¡`ä¸ºé©±åŠ¨ æŒæ¡æ¡†æ¶çš„ä½¿ç”¨

ä»¥ä¸‹å†™çš„æ˜¯ä¸šåŠ¡ã€‚

`xxserviceRpc` æ˜¯ç»™æœåŠ¡æä¾›è€…ç”¨ï¼Œ `xxServiceRpc_Stub` æœåŠ¡è°ƒç”¨è€…

æµç¨‹ï¼š

å…ˆåœ¨`user.proto`ä¸­è¿›è¡Œç›¸åº”çš„çº¦å®šï¼Œå£°æ˜è°ƒç”¨çš„å‡½æ•°ä»¥åŠè°ƒç”¨å½¢å¼å’Œè¿”å›å€¼

ç„¶åç»§æ‰¿è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»ï¼Œç±»ä¸­æ–¹æ³•å°±æ˜¯protoä¸­å†™çš„rpcæ–¹æ³•

è®©æ¡†æ¶æ¥è°ƒç”¨æˆ‘æˆ‘ä»¬çš„ä»£ç 

user.protoæ–¹æ³•

```protobuf
message LoginRequest
{
    bytes name = 1;
    bytes pwd = 2;
}

message LoginResponse
{
    ResultCode result = 1;
    bool sucess = 2;
}
```



```cpp
/*
UserServiceåŸæ¥æ˜¯ä¸€ä¸ªæœ¬åœ°æœåŠ¡ï¼Œæä¾›äº†ä¸¤ä¸ªè¿›ç¨‹å†…çš„æœ¬åœ°æ–¹æ³•ï¼ŒLoginå’ŒGetFriendLists
*/
class UserService : public fixbug::UserServiceRpc // ä½¿ç”¨åœ¨rpcæœåŠ¡å‘å¸ƒç«¯ï¼ˆrpcæœåŠ¡æä¾›è€…ï¼‰
{
public:
    bool Login(std::string name, std::string pwd)
    {
        std::cout << "doing local service: Login" << std::endl;
        std::cout << "name:" << name << " pwd:" << pwd << std::endl;  
        return false;
    }
 
       /*
    é‡å†™åŸºç±»UserServiceRpcçš„è™šå‡½æ•° ä¸‹é¢è¿™äº›æ–¹æ³•éƒ½æ˜¯æ¡†æ¶ç›´æ¥è°ƒç”¨çš„
    1. caller   ===>   Login(LoginRequest)  => muduo =>   callee 
    2. callee   ===>    Login(LoginRequest)  => äº¤åˆ°ä¸‹é¢é‡å†™çš„è¿™ä¸ªLoginæ–¹æ³•ä¸Šäº†
    */
    void Login(::google::protobuf::RpcController* controller,
                       const ::fixbug::LoginRequest* request,
                       ::fixbug::LoginResponse* response,
                       ::google::protobuf::Closure* done)
    {
        // æ¡†æ¶ç»™ä¸šåŠ¡ä¸ŠæŠ¥äº†è¯·æ±‚å‚æ•°LoginRequestï¼Œåº”ç”¨è·å–ç›¸åº”æ•°æ®åšæœ¬åœ°ä¸šåŠ¡
        std::string name = request->name();
        std::string pwd = request->pwd();

        // åšæœ¬åœ°ä¸šåŠ¡
        bool login_result = Login(name, pwd); 

        // æŠŠå“åº”å†™å…¥  åŒ…æ‹¬é”™è¯¯ç ã€é”™è¯¯æ¶ˆæ¯ã€è¿”å›å€¼
        fixbug::ResultCode *code = response->mutable_result();
        code->set_errcode(0);
        code->set_errmsg("");
        response->set_sucess(login_result);

        // æ‰§è¡Œå›è°ƒæ“ä½œ   æ‰§è¡Œå“åº”å¯¹è±¡æ•°æ®çš„åºåˆ—åŒ–å’Œç½‘ç»œå‘é€ï¼ˆéƒ½æ˜¯ç”±æ¡†æ¶æ¥å®Œæˆçš„ï¼‰
        done->Run();
    }

}
```

> æ³¨æ„ä½¿ç”¨å‘½åç©ºé—´ 

æ¡†æ¶å¸®æˆ‘ä»¬ä»è¿œç«¯æ¥æ”¶RPCè¯·æ±‚ï¼ŒRPCæè¿°æ–¹æ³•å’Œå‚æ•°ï¼Œé€šè¿‡ä¸€ç³»åˆ—å‚æ•°å®Œæˆå“åº”çš„å‡½æ•°



ä»€ä¹ˆå«åšæœ¬åœ°ä¸šåŠ¡





## `Mprpc`æ¡†æ¶åŸºç¡€ç±»è®¾è®¡

è°ƒç”¨æ¡†æ¶çš„åˆå§‹åŒ–æ“ä½œ

æ¡†æ¶å¯ä»¥æä¾›æœåŠ¡ `provider` å¯¹è±¡

å¯åŠ¨ä¸€ä¸ªRPCæœåŠ¡å‘å¸ƒèŠ‚ç‚¹ï¼Œ`Run`ä»¥åï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è¿œç¨‹çš„`rpc`è°ƒç”¨è¯·æ±‚



```cpp
int main(int argc, char **argv)
{
    // è°ƒç”¨æ¡†æ¶çš„åˆå§‹åŒ–æ“ä½œ
    MprpcApplication::Init(argc, argv);

    // provideræ˜¯ä¸€ä¸ªrpcç½‘ç»œæœåŠ¡å¯¹è±¡ã€‚æŠŠUserServiceå¯¹è±¡å‘å¸ƒåˆ°rpcèŠ‚ç‚¹ä¸Š
    RpcProvider provider;
    provider.NotifyService(new UserService());

    // å¯åŠ¨ä¸€ä¸ªrpcæœåŠ¡å‘å¸ƒèŠ‚ç‚¹   Runä»¥åï¼Œè¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…è¿œç¨‹çš„rpcè°ƒç”¨è¯·æ±‚
    provider.Run();

    return 0;
}
```



æ¡†æ¶çš„ä»£ç éƒ½æ˜¯æ”¾åœ¨srcï¼ŒåŠ¨æ€åº“éƒ½åœ¨æ”¾åœ¨`src.include`ä¸­





# å…·ä½“çš„å®ç°

æ³¨æ„ï¼š

æˆ‘ä»¬æ­å»ºrpcçš„æœåŠ¡æ¡†æ¶çš„æ—¶å€™ï¼Œæ˜¯è¦æ­å»ºé€šç”¨çš„æ¡†æ¶ï¼Œæ¯”å¦‚åœ¨`rpcprovider.h`ä¸­çš„ `NotifyServie`æœåŠ¡ä¸­ï¼Œæˆ‘çš„å‚æ•°å¯¹è±¡åº”è¯¥ä¸º`google::protobuf::Service *service`

```
    // è¿™é‡Œæ˜¯æ¡†æ¶æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„ï¼Œå¯ä»¥å‘å¸ƒrpcæ–¹æ³•çš„å‡½æ•°æ¥å£
    void NotifyService(google::protobuf::Service *service);

    // å¯åŠ¨rpcæœåŠ¡èŠ‚ç‚¹ï¼Œå¼€å§‹æä¾›rpcè¿œç¨‹ç½‘ç»œè°ƒç”¨æœåŠ¡
    void Run();
```







## 20225.25

æ‰¾åˆ°ç›¸å…³çš„ä»£ç 

> https://github.com/wangzyon/mpzRPC

é…ç½®ç¯å¢ƒ

> è½»é‡çº§çš„ [MessagePack RPC](https://github.com/msgpack-rpc/msgpack-rpc) è¿œç¨‹æ–¹æ³•è°ƒç”¨åº“

muduoåº“

google protobuf å®‰è£…

linux ISO

ä¸€äº›å¸¸è§çš„apt æŒ‡ä»¤ 

dockerå®¹å™¨é…ç½®











**for apt-get:**
export PATH=/usr/bin:$PATH
protoc --version

**and for source:**
export PATH=/usr/local/bin:$PATH
protoc --version

> then removed the one installed through source,next I checked again and both were the same version.
> after that I used **make clean**, and then **make test**, and voila! the problem solved for my case.





probuf bug

```
/tmp/ccIrH6FT.o: In function `google::protobuf::internal::GetEmptyStringAlreadyInited[abi:cxx11]()':
mymain.cc:(.text._ZN6google8protobuf8internal27GetEmptyStringAlreadyInitedB5cxx11Ev[_ZN6google8protobuf8internal27GetEmptyStringAlreadyInitedB5cxx11Ev]+0x5): undefined reference to `google::protobuf::internal::fixed_address_empty_string[abi:cxx11]'
/tmp/ccJVtnAI.o: In function `fixbug::protobuf_mytest_2eproto::(anonymous namespace)::protobuf_AssignDescriptors()':
mytest.pb.cc:(.text+0x6e): undefined reference to `google::protobuf::internal::AssignDescriptors(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&, google::protobuf::internal::MigrationSchema const*, google::protobuf::Message const* const*, unsigned int const*, google::protobuf::MessageFactory*, google::protobuf::Metadata*, google::protobuf::EnumDescriptor const**, google::protobuf::ServiceDescriptor const**)'
/tmp/ccJVtnAI.o: In function `fixbug::protobuf_mytest_2eproto::(anonymous namespace)::protobuf_RegisterTypes(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const&)':
mytest.pb.cc:(.text+0x108): undefined reference to `google::protobuf::internal::RegisterAllTypes(google::protobuf::Metadata const*, int)'
/tmp/ccJVtnAI.o: In function `fixbug::protobuf_mytest_2eproto::TableStruct::InitDefaultsImpl()':
mytest.pb.cc:(.text+0x1ce): undefined reference to `google::protobuf::internal::InitProtobufDefaults()'
/tmp/ccJVtnAI.o: In function `fixbug::ResultCode::ResultCode(fixbug::ResultCode const&)':
mytest.pb.cc:(.text+0x440): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
/tmp/ccJVtnAI.o: In function `fixbug::ResultCode::MergePartialFromCodedStream(google::protobuf::io::CodedInputStream*)':
mytest.pb.cc:(.text+0x82a): undefined reference to `google::protobuf::io::CodedInputStream::ReadTagFallback(unsigned int)'
/tmp/ccJVtnAI.o: In function `fixbug::ResultCode::MergeFrom(fixbug::ResultCode const&)':
mytest.pb.cc:(.text+0xdb6): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
/tmp/ccJVtnAI.o: In function `fixbug::LoginRequest::LoginRequest(fixbug::LoginRequest const&)':
mytest.pb.cc:(.text+0x1186): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
mytest.pb.cc:(.text+0x11e2): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
/tmp/ccJVtnAI.o: In function `fixbug::LoginRequest::MergePartialFromCodedStream(google::protobuf::io::CodedInputStream*)':
mytest.pb.cc:(.text+0x15fa): undefined reference to `google::protobuf::io::CodedInputStream::ReadTagFallback(unsigned int)'
/tmp/ccJVtnAI.o: In function `fixbug::LoginRequest::MergeFrom(fixbug::LoginRequest const&)':
mytest.pb.cc:(.text+0x1bb2): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
mytest.pb.cc:(.text+0x1bfc): undefined reference to `google::protobuf::internal::ArenaStringPtr::AssignWithDefault(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > const*, google::protobuf::internal::ArenaStringPtr)'
/tmp/ccJVtnAI.o: In function `fixbug::LoginResponse::MergePartialFromCodedStream(google::protobuf::io::CodedInputStream*)':
mytest.pb.cc:(.text+0x23e8): undefined reference to `google::protobuf::io::CodedInputStream::ReadTagFallback(unsigned int)'
/tmp/ccJVtnAI.o: In function `google::protobuf::io::CodedOutputStream::IsDefaultSerializationDeterministic()':
mytest.pb.cc:(.text._ZN6google8protobuf2io17CodedOutputStream35IsDefaultSerializationDeterministicEv[_ZN6google8protobuf2io17CodedOutputStream35IsDefaultSerializationDeterministicEv]+0x7): undefined reference to `google::protobuf::io::CodedOutputStream::default_serialization_deterministic_'
/tmp/ccJVtnAI.o: In function `google::protobuf::io::CodedInputStream::ReadVarint32(unsigned int*)':
mytest.pb.cc:(.text._ZN6google8protobuf2io16CodedInputStream12ReadVarint32EPj[_ZN6google8protobuf2io16CodedInputStream12ReadVarint32EPj]+0x78): undefined reference to `google::protobuf::io::CodedInputStream::ReadVarint32Fallback(unsigned int)'
/tmp/ccJVtnAI.o: In function `google::protobuf::io::CodedInputStream::ReadVarint64(unsigned long*)':
mytest.pb.cc:(.text._ZN6google8protobuf2io16CodedInputStream12ReadVarint64EPm[_ZN6google8protobuf2io16CodedInputStream12ReadVarint64EPm]+0x6f): undefined reference to `google::protobuf::io::CodedInputStream::ReadVarint64Fallback()'
/tmp/ccJVtnAI.o: In function `google::protobuf::io::CodedInputStream::ReadVarintSizeAsInt(int*)':
mytest.pb.cc:(.text._ZN6google8protobuf2io16CodedInputStream19ReadVarintSizeAsIntEPi[_ZN6google8protobuf2io16CodedInputStream19ReadVarintSizeAsIntEPi]+0x6c): undefined reference to `google::protobuf::io::CodedInputStream::ReadVarintSizeAsIntFallback()'
/tmp/ccJVtnAI.o: In function `google::protobuf::internal::InternalMetadataWithArena::default_instance()':
mytest.pb.cc:(.text._ZN6google8protobuf8internal25InternalMetadataWithArena16default_instanceEv[_ZN6google8protobuf8internal25InternalMetadataWithArena16default_instanceEv]+0x5): undefined reference to `google::protobuf::UnknownFieldSet::default_instance()'
/tmp/ccJVtnAI.o: In function `void google::protobuf::Arena::Own<fixbug::ResultCode>(fixbug::ResultCode*)':
mytest.pb.cc:(.text._ZN6google8protobuf5Arena3OwnIN6fixbug10ResultCodeEEEvPT_[_ZN6google8protobuf5Arena3OwnIN6fixbug10ResultCodeEEEvPT_]+0x4d): undefined reference to `google::protobuf::Arena::AddListNode(void*, void (*)(void*))'
/tmp/ccJVtnAI.o: In function `void google::protobuf::Arena::Own<fixbug::LoginRequest>(fixbug::LoginRequest*)':
mytest.pb.cc:(.text._ZN6google8protobuf5Arena3OwnIN6fixbug12LoginRequestEEEvPT_[_ZN6google8protobuf5Arena3OwnIN6fixbug12LoginRequestEEEvPT_]+0x4d): undefined reference to `google::protobuf::Arena::AddListNode(void*, void (*)(void*))'
/tmp/ccJVtnAI.o: In function `void google::protobuf::Arena::Own<fixbug::LoginResponse>(fixbug::LoginResponse*)':
mytest.pb.cc:(.text._ZN6google8protobuf5Arena3OwnIN6fixbug13LoginResponseEEEvPT_[_ZN6google8protobuf5Arena3OwnIN6fixbug13LoginResponseEEEvPT_]+0x4d): undefined reference to `google::protobuf::Arena::AddListNode(void*, void (*)(void*))'
/tmp/ccJVtnAI.o: In function `bool google::protobuf::internal::WireFormatLite::ReadMessageNoVirtual<fixbug::ResultCode>(google::protobuf::io::CodedInputStream*, fixbug::ResultCode*)':
mytest.pb.cc:(.text._ZN6google8protobuf8internal14WireFormatLite20ReadMessageNoVirtualIN6fixbug10ResultCodeEEEbPNS0_2io16CodedInputStreamEPT_[_ZN6google8protobuf8internal14WireFormatLite20ReadMessageNoVirtualIN6fixbug10ResultCodeEEEbPNS0_2io16CodedInputStreamEPT_]+0x4d): undefined reference to `google::protobuf::io::CodedInputStream::IncrementRecursionDepthAndPushLimit(int)'
mytest.pb.cc:(.text._ZN6google8protobuf8internal14WireFormatLite20ReadMessageNoVirtualIN6fixbug10ResultCodeEEEbPNS0_2io16CodedInputStreamEPT_[_ZN6google8protobuf8internal14WireFormatLite20ReadMessageNoVirtualIN6fixbug10ResultCodeEEEbPNS0_2io16CodedInputStreamEPT_]+0x9a): undefined reference to `google::protobuf::io::CodedInputStream::DecrementRecursionDepthAndPopLimit(int)'
/tmp/ccJVtnAI.o: In function `google::protobuf::internal::InternalMetadataWithArenaBase<google::protobuf::UnknownFieldSet, google::protobuf::internal::InternalMetadataWithArena>::mutable_unknown_fields_slow()':
mytest.pb.cc:(.text._ZN6google8protobuf8internal29InternalMetadataWithArenaBaseINS0_15UnknownFieldSetENS1_25InternalMetadataWithArenaEE27mutable_unknown_fields_slowEv[_ZN6google8protobuf8internal29InternalMetadataWithArenaBaseINS0_15UnknownFieldSetENS1_25InternalMetadataWithArenaEE27mutable_unknown_fields_slowEv]+0xc1): undefined reference to `google::protobuf::Arena::AllocateAligned(std::type_info const*, unsigned long)'
mytest.pb.cc:(.text._ZN6google8protobuf8internal29InternalMetadataWithArenaBaseINS0_15UnknownFieldSetENS1_25InternalMetadataWithArenaEE27mutable_unknown_fields_slowEv[_ZN6google8protobuf8internal29InternalMetadataWithArenaBaseINS0_15UnknownFieldSetENS1_25InternalMetadataWithArenaEE27mutable_unknown_fields_slowEv]+0x11f): undefined reference to `google::protobuf::Arena::AddListNode(void*, void (*)(void*))'
```



**è§£å†³åŠæ³•**

```
 g++ mymain.cc mytest.pb.cc `pkg-config --cflags --libs protobuf`
```

https://stackoverflow.com/questions/30124264/undefined-reference-to-googleprotobufinternalempty-string-abicxx11













![image-20220603175806134](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220603175806134.png)

ä¹Ÿå°±æ˜¯è¯´RpcProviderä¸»è¦æä¾›ä¸‰éƒ¨åˆ†åŠŸèƒ½ï¼š

ç½‘ç»œåŠŸèƒ½muduoåº“æ¥å®ç°ï¼Œprotobufå®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–

ä»¥åŠåœ¨`NotifyService`ä¸­ç”Ÿæˆä¸€å¼ è¡¨ï¼Œè®°å½•æœåŠ¡å¯¹è±¡å’Œå…¶å‘å¸ƒçš„æ‰€æœ‰çš„æœåŠ¡æ–¹æ³•ã€‚





å†…éƒ¨é€šä¿¡æ¡†æ¶çš„å›¾ï¼Œé‡æ–°ç”»ä¸€éã€‚





### å®ç°RPCæ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹

![image-20220605091641550](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220605091641550.png)





### åŠŸèƒ½çš„ç‚¹å¯¹ç‚¹çš„æµ‹è¯•

```
gdb ./consumer
break mprpcchannel:116
run -i test.conf
p recv_buf
```

æ³¨æ„:

åœ¨ååºåˆ—çš„è¿‡ç¨‹ä¸­

`recv_buf` ä¸­é‡åˆ°'\0'åé¢çš„æ•°æ®å°±å­˜ä¸ä¸‹æ¥äº†ï¼Œå¯¼è‡´ååºåˆ—å¤±è´¥

```cpp
    // ååºåˆ—åŒ–rpcè°ƒç”¨çš„å“åº”æ•°æ®
    // std::string response_str(recv_buf, 0, recv_size); // bugå‡ºç°é—®é¢˜ï¼Œrecv_bufä¸­é‡åˆ°\0åé¢çš„æ•°æ®å°±å­˜ä¸ä¸‹æ¥äº†ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥
    // if (!response->ParseFromString(response_str))
    if (!response->ParseFromArray(recv_buf, recv_size))
    {
        close(clientfd);
        char errtxt[512] = {0};
        sprintf(errtxt, "parse error! response_str:%s", recv_buf);
        controller->SetFailed(errtxt);
        return;
    }
```



é€šä¿¡çš„è¿‡ç¨‹ï¼š

ç›´è¿ dian'dui

```shell
./provider -i test.conf # å¯åŠ¨è°ƒç”¨çš„æä¾›è€…
./consumer -i test.conf  # å¯åŠ¨è°ƒç”¨
```

ç”Ÿæˆçš„é™æ€åº“



ä¸¾ä¸ªæ —å­

## Mprpcæ¡†æ¶çš„åº”ç”¨å®ä¾‹

å‡è®¾æˆ‘ä»¬æ˜¯ä½¿ç”¨æ–¹ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°æºç ã€‚

æ³¨å†Œæ–¹æ³•çš„å‘å¸ƒï¼š

ç°åœ¨user.protoc:

```
message RegisterRequest
{
    uint32 id = 1;
    bytes name = 2;
    bytes pwd = 3;
}

message RegisterResponse
{
    ResultCode result = 1;
    bool sucess = 2;
}
```

é‡æ–°ç”ŸæˆC++ä»£ç 

protoc user.proto --cpp_out=./



åœ¨example/callee userservice.ccä¸­

```
    bool Register(uint32_t id, std::string name, std::string pwd)
    {
        std::cout << "doing local service: Register" << std::endl;
        std::cout << "id:" << id << "name:" << name << " pwd:" << pwd << std::endl;
        return true;
    }
```

æ¡†æ¶å¸®æˆ‘è°ƒç”¨çš„æ–¹æ³•ï¼š

```cpp
    void Register(::google::protobuf::RpcController* controller,
                       const ::fixbug::RegisterRequest* request,
                       ::fixbug::RegisterResponse* response,
                       ::google::protobuf::Closure* done)
    {
        // ä»è¯·æ±‚ä¸­è·å–å€¼
        uint32_t id = request->id();
        std::string name = request->name();
        std::string pwd = request->pwd();
		// æœ¬åœ°ä¸šåŠ¡
        bool ret = Register(id, name, pwd);

        response->mutable_result()->set_errcode(0);
        response->mutable_result()->set_errmsg("");
        response->set_sucess(ret);
		
        // doneçš„å›è°ƒï¼šè¿›è¡Œæ•°æ®çš„åºåˆ—åŒ–ï¼Œå¹¶é€šè¿‡ç½‘ç»œå‘å›ç»™RPC clientä¸­
        done->Run();
    }
```





ä»–äººè°ƒç”¨çš„æ—¶å€™

`example/caller/calluserservice.cc`

```
    // æ¼”ç¤ºè°ƒç”¨è¿œç¨‹å‘å¸ƒçš„rpcæ–¹æ³•Register
    fixbug::RegisterRequest req;
    req.set_id(2000);
    req.set_name("mprpc");
    req.set_pwd("666666");
    fixbug::RegisterResponse rsp;

    // ä»¥åŒæ­¥çš„æ–¹å¼å‘èµ·rpcè°ƒç”¨è¯·æ±‚ï¼Œç­‰å¾…è¿”å›ç»“æœ
    stub.Register(nullptr, &req, &rsp, nullptr);

    // ä¸€æ¬¡rpcè°ƒç”¨å®Œæˆï¼Œè¯»è°ƒç”¨çš„ç»“æœ
    if (0 == rsp.result().errcode())
    {
        std::cout << "rpc register response success:" << rsp.sucess() << std::endl;
    }
    else
    {
        std::cout << "rpc register response error : " << rsp.result().errmsg() << std::endl;
    }
```

å¯åŠ¨

```
./provider -i test.conf # å¯åŠ¨è°ƒç”¨çš„æä¾›è€…
./consumer -i test.conf  # å¯åŠ¨è°ƒç”¨
```





### æ·»åŠ å¥½å‹çš„æ¨¡å—

å…ˆå†™ä¸€ä¸ªprotoc

ç„¶ååœ¨calleeä¸­ å¡«å†™





åœ¨callerä¸­å¡«å†™

```
int main(int argc, char **argv)
{
    // æ•´ä¸ªç¨‹åºå¯åŠ¨ä»¥åï¼Œæƒ³ä½¿ç”¨mprpcæ¡†æ¶æ¥äº«å—rpcæœåŠ¡è°ƒç”¨ï¼Œä¸€å®šéœ€è¦å…ˆè°ƒç”¨æ¡†æ¶çš„åˆå§‹åŒ–å‡½æ•°ï¼ˆåªåˆå§‹åŒ–ä¸€æ¬¡ï¼‰
    MprpcApplication::Init(argc, argv);

    // æ¼”ç¤ºè°ƒç”¨è¿œç¨‹å‘å¸ƒçš„rpcæ–¹æ³•Login
    fixbug::FriendServiceRpc_Stub stub(new MprpcChannel());
    // rpcæ–¹æ³•çš„è¯·æ±‚å‚æ•°
    fixbug::GetFriendsListRequest request;
    request.set_userid(1000);
    // rpcæ–¹æ³•çš„å“åº”
    fixbug::GetFriendsListResponse response;
    // å‘èµ·rpcæ–¹æ³•çš„è°ƒç”¨  åŒæ­¥çš„rpcè°ƒç”¨è¿‡ç¨‹  MprpcChannel::callmethod
    MprpcController controller;
    stub.GetFriendsList(&controller, &request, &response, nullptr); // RpcChannel->RpcChannel::callMethod é›†ä¸­æ¥åšæ‰€æœ‰rpcæ–¹æ³•è°ƒç”¨çš„å‚æ•°åºåˆ—åŒ–å’Œç½‘ç»œå‘é€

    // ä¸€æ¬¡rpcè°ƒç”¨å®Œæˆï¼Œè¯»è°ƒç”¨çš„ç»“æœ
    if (controller.Failed())
    {
        std::cout << controller.ErrorText() << std::endl;
    }
    else
    {
        if (0 == response.result().errcode())
        {
            std::cout << "rpc GetFriendsList response success!" << std::endl;
            // é€šè¿‡friend_size å¾—åˆ°å¥½å‹æ•°é‡
            int size = response.friends_size();
            for (int i = 0; i < size; ++i)
            {
                std::cout << "index:" << (i + 1) << " name:" << response.friends(i) << std::endl;
            }
        }
        else
        {
            std::cout << "rpc GetFriendsList response error : " << response.result().errmsg() << std::endl;
        }
    }

    return 0;
}
```

è¿è¡Œï¼š







## RpcConstrolleræ§åˆ¶æ¨¡å—å®ç°

å› ä¸ºåœ¨channelä¸­ï¼Œå­˜åœ¨ç›´æ¥è¿”å›ï¼Œåœ¨ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™ï¼Œè°ƒç”¨å¯¹åº”çš„response ä¼šå‡ºé”™

```
    // åºåˆ—åŒ–
    if (rpcHeader.SerializeToString(&rpc_header_str))
    {
        header_size = rpc_header_str.size();
    }
    else
    {
        controller->SetFailed("serialize rpc header error!");
        return;
    }
```

åˆ©ç”¨`control`è¿›è¡Œä¿¡æ¯æ§åˆ¶ï¼Œé€šè¿‡`control`æºå¸¦rpcè°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„ä¿¡æ¯







## loggeræ—¥å¿—ç³»ç»Ÿè®¾è®¡

ä¸»è¦å›´ç»•ä¸¤ä¸ªé—®é¢˜ï¼š
queueå¿…é¡»ä¿è¯çº¿ç¨‹å®‰å…¨

> C++ è™½ç„¶æä¾›äº†queueä½†æ˜¯ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

çº¿ç¨‹é—´é€šä¿¡

é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œæœ‰å¿…è¦æ‰æŠ¢é”ã€‚



kafka  `åˆ†å¸ƒå¼é˜Ÿåˆ—`

æ—¥å¿—ç³»ç»Ÿçš„å®ç°





æµ‹è¯•

```
    LOG_INFO("first log message!");
    LOG_ERR("%s:%s:%d", __FILE__, __FUNCTION__, __LINE__);
```

å°†ä»£ç é›†æˆåˆ°ç³»ç»Ÿä¹‹ä¸­





# Zookeeperç®€ä»‹

Zookeeperåˆ†å¸ƒå¼åè°ƒæœåŠ¡

ä¼˜ç‚¹ï¼š

æ¶ˆæ¯ä¸­å¿ƒ

åˆ†å¸ƒå¼é”



RPCé€šä¿¡éœ€è¦çŸ¥é“

åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œéœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼ç½‘ç»œé…ç½®ä¸­å¿ƒæ¥è®°å½•ä¸€ä¸‹åˆ†å¸ƒå¼èŠ‚ç‚¹æ‰€æœ‰å‘å¸ƒRPCæœåŠ¡çš„ä¸»æœºåœ°å€å’Œç«¯å£å·ã€‚



zookeråˆ†å¸ƒå¼é”





### åœ¨æœ¬é¡¹ç›®ä¸­å®ä¾‹ä¸­

![image-20220606091516782](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220606091516782.png)



å…·ä½“æ˜¯å¦‚ä½•å¯»æ‰¾çš„å‘¢ï¼Ÿ

![image-20220606091530814](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220606091530814.png)





é‡åˆ°çªå‘æƒ…å†µï¼Œæ¯”å¦‚æ–­ç‚¹ä»€ä¹ˆçš„

**å®šæœŸå‘å‡ºä¸€ä¸ªå¿ƒè·³æ¶ˆæ¯**

å¯é çš„æ–¹å¼åˆ¤æ–­TCPæ˜¯å¦æ–­å¼€



å¿ƒè·³è®¡æ•°ä¸º4ï¼Œæ¯éš”ä¸€åˆ†é’Ÿå¢åŠ 1ï¼Œæ”¶åˆ°å°±å‡ä¸€

![image-20220606091030705](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220606091030705.png)



zkæ³¨å†Œä¸­å¿ƒå’Œæ¯ä¸ªèŠ‚ç‚¹ ç»´æŒä¸€ä¸ª`session` ä¼šè¯

é€šè¿‡sessionä¼šè¯ç»´æŒå¿ƒè·³



- ä¸´æ—¶æ€§èŠ‚ç‚¹ `rpc`èŠ‚ç‚¹è¶…æ—¶æœªå‘é€å¿ƒè·³ä¿¡æ¯ï¼Œzkä¼šè‡ªåŠ¨åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹
- æ°¸ä¹…æ€§èŠ‚ç‚¹ï¼ŒrpcèŠ‚ç‚¹è¶…æ—¶æœªå‘é€å¿ƒè·³ zkä¸ä¼šåˆ é™¤è¿™ä¸ªèŠ‚ç‚¹ã€‚









åˆ†å¸ƒå¼é”

ä¸»ä»èŠ‚ç‚¹åˆ‡æ¢

åˆ†å¸ƒå¼åè°ƒé«˜å¯ç”¨



## zkçš„watchæœºåˆ¶

ç›‘å¬æœºåˆ¶ï¼šäº‹ä»¶å›è°ƒæœºåˆ¶

åœ¨å®¢æˆ·ç«¯ç»´æŠ¤ä¸€ä¸ªmapè¡¨

é”®èŠ‚ç‚¹çš„åå­—ï¼Œå€¼

ç›‘å¬èŠ‚ç‚¹å˜åŒ–



æœ‰å˜åŒ–ä¸»åŠ¨çš„é€šçŸ¥





## åŸç”Ÿçš„APIå­˜åœ¨çš„ç¼ºç‚¹

ZookeeperåŸç”Ÿæä¾›äº†Cå’ŒJavaçš„å®¢æˆ·ç«¯ç¼–ç¨‹æ¥å£ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ç›¸å¯¹å¤æ‚ï¼Œå‡ ä¸ªå¼±ç‚¹ï¼š
1.ä¸ä¼šè‡ªåŠ¨å‘é€å¿ƒè·³æ¶ˆæ¯ <==== **é”™è¯¯ï¼Œæºç ä¸Šä¼šåœ¨1/3çš„Timeoutæ—¶é—´å‘é€pingå¿ƒè·³æ¶ˆæ¯**
2.è®¾ç½®ç›‘å¬watcheråªèƒ½æ˜¯ä¸€æ¬¡æ€§çš„
æ¯æ¬¡è§¦å‘åéœ€è¦é‡å¤è®¾ç½®
å®¢æˆ·ç«¯åœ¨èŠ‚ç‚¹æ³¨å†Œwatcherçš„æ—¶å€™ï¼Œæ•°æ®çš„æ”¹åŠ¨éƒ½é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯åªé€šçŸ¥1æ¬¡ã€‚è¦å®ƒé€šçŸ¥ç¬¬2æ¬¡å¾—é‡æ–°å†å»æ³¨å†Œã€‚
3.znodeèŠ‚ç‚¹åªå­˜å‚¨ç®€å•çš„byteå­—èŠ‚æ•°ç»„
å¦‚æœå­˜å‚¨å¯¹è±¡ï¼Œéœ€è¦è‡ªå·±è½¬æ¢å¯¹è±¡ç”Ÿæˆå­—èŠ‚æ•°ç»„(è‡ªå·±ç”¨jsonæˆ–è€…protobufï¼‰



ä¼šåœ¨1/3çš„Timeoutæ—¶é—´å‘é€pingå¿ƒè·³æ¶ˆæ¯ 

sudo tcpdump -i lo port 2181

![image-20220606101427733](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220606101427733.png)







æ°¸ä¹…æ€§èŠ‚ç‚¹ï¼š

å¦‚ä½•åˆ¤æ–­

![image-20220606094935526](https://ydlin.oss-cn-guangzhou.aliyuncs.com/blog-img/image-20220606094935526.png)







## è¿™éƒ¨åˆ†åœ¨é¡¹ç›®ä¸­çš„è¿ç”¨

ä¸»è¦æ˜¯ä¸‰ä¸ªåŠŸèƒ½

- è¿æ¥
- åˆ›å»º
- è·å–èŠ‚ç‚¹å€¼

ä½œç”¨ï¼š

>   /*
>
>   zookeeper_mtï¼šå¤šçº¿ç¨‹ç‰ˆæœ¬
>
>   zookeeperçš„APIå®¢æˆ·ç«¯ç¨‹åºæä¾›äº†ä¸‰ä¸ªçº¿ç¨‹
>
>   APIè°ƒç”¨çº¿ç¨‹
>
>   ç½‘ç»œI/Oçº¿ç¨‹  pthread_create  poll æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ç¨‹åº ä¸éœ€è¦åšé«˜å¹¶å‘
>
>   watcherå›è°ƒçº¿ç¨‹ pthread_create
>
>   */



# æ€»ç»“ä¸ä½¿ç”¨

é™æ€åº“ï¼š

å°†æ–‡ä»¶å­˜åˆ°

user/lib

uer/local/include



å…·ä½“çš„ä½¿ç”¨
